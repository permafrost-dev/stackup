# This file can be run with the `task` utility: https://taskfile.dev/
version: '3'

dotenv: ['.env', '.env.local']

vars:
  APP_VERSION_FILE: './lib/version/app-version.go'
  ENTRY_FILENAME: './app/main.go'
  BUILD_OUTPUT_DIR: './dist'
  BINARY_FILENAME: 'stackup'
  DIST_TARGET_FILE: '{{.BUILD_OUTPUT_DIR}}/{{.BINARY_FILENAME}}'
  DOTENV_FILES:
    sh: find . -name ".env*" -print | sort -u | egrep -v '^./dist.*$' | tr '\n' ' '

tasks:

  mod:
    desc: Downloads and tidy Go modules
    cmds:
      - go mod download
      - go mod tidy

  build:
    desc: Builds application
    preconditions:
      - task: prepare-dist-folder
      - task: mod
    deps:
      - task: update-version-file
    cmds:
      - task: build-stackup
      - task: copy-config-template-to-dist

  clean:
    desc: Cleans up build artifacts
    preconditions:
      - test -d {{.BUILD_OUTPUT_DIR}}
      - test -f {{.DIST_TARGET_FILE}}
    cmds:
      - rm -f {{.DIST_TARGET_FILE}}

  lint:
    cmds:
      - task: lint-dotenv
      - task: lint-stackup

  update-version-file:
    preconditions:
      # don't run this task in CI
      - sh: '[ "$CI" == "" ]'
    cmds:
      - go run tools/generate-version-file.go

  lint-dotenv:
    desc: Lints all dotenv files
    preconditions:
      - which dotenv-linter
    cmds:
      - dotenv-linter {{.DOTENV_FILES}}

  lint-stackup:
    desc: Runs golangci-lint
    vars:
      SRC_DIRS:
        sh: find . -name "*.go" -printf '%h\n' | awk -F/ '{ print "./" $2 }' | sort -u | grep -v './tools' | tr '\n' ' '
    preconditions:
      - which golangci-lint
    cmds:
      - golangci-lint run {{.SRC_DIRS}}

  prepare-dist-folder:
    desc: Prepares dist folder
    silent: true
    cmds:
      - mkdir -p {{.BUILD_OUTPUT_DIR}}

  build-stackup:
    desc: Builds stackup binary
    vars:
      GIT_COMMIT:
        sh: git log -n 1 --format=%h
    deps:
      - task: prepare-dist-folder
    sources:
      - '{{.ENTRY_FILENAME}}'
    generates:
      - '{{.DIST_TARGET_FILE}}'
    cmds:
      - go build -trimpath -ldflags="-s -w -X main.Version={{.VERSION}}-{{.GIT_COMMIT}}" -o {{.DIST_TARGET_FILE}} {{.ENTRY_FILENAME}}

  copy-config-template-to-dist:
    desc: Copies config template to dist folder
    deps:
      - task: prepare-dist-folder
    cmds:
      - cp -f ./templates/*.yaml {{.BUILD_OUTPUT_DIR}}

  bump-minor-version-and-tag:
    run: once
    desc: Bumps minor version and creates a new git tag
    preconditions:
      - which svu
    cmds:
      - echo "bumping version to $(svu minor)"
      - git tag $(svu minor)

  release-new-minor-version:
    desc: Create a new minor version release on github
    cmds:
      - task: bump-minor-version-and-tag
      - task: update-version-file
      - git push --tags

  update-checksums:
    dir: templates/remote-includes
    cmds:
      - sha256sum containers.yaml > containers.yaml.sha256
      - sha256sum laravel.yaml > laravel.yaml.sha256
      - sha256sum node.yaml > node.yaml.sha256
      - sha256sum php.yaml > php.yaml.sha256
      - sha256sum python.yaml > python.yaml.sha256
      - sha256sum *.yaml > checksums.sha256.txt
      - task: commit-updated-checksums

  commit-updated-checksums:
    desc: Commits updated checksum files
    internal: true
    silent: true
    cmds:
      - git add templates/remote-includes/*.sha256 templates/remote-includes/checksums.*.txt
      - git commit -m "update checksum files"
